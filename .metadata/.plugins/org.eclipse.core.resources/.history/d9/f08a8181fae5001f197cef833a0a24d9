package com.jsp.hibernate_actor_movie.dao;

import java.util.ArrayList;
import java.util.List;
import java.util.Scanner;

import javax.persistence.EntityManager;
import javax.persistence.EntityManagerFactory;
import javax.persistence.EntityTransaction;
import javax.persistence.Persistence;
import javax.persistence.Query;
import javax.persistence.criteria.CriteriaBuilder;
import javax.persistence.criteria.CriteriaQuery;
import javax.persistence.criteria.Root;

import com.jsp.hibernate_actor_movie.entity.Actor;
import com.jsp.hibernate_actor_movie.entity.Movie;

public class MovieDao {

	EntityManagerFactory emf = null;
	Scanner sc = new Scanner(System.in);

	public void addMovie() {
		Movie m = new Movie();
		System.out.println("Enter the movie Id");
		m.setMovieId(sc.nextInt());
		System.out.println("Enter the movie Title");
		m.setMovieTitle(sc.next());
		System.out.println("----------------");
		System.out.println("Enter the movie director");
		m.setMovieDirector(sc.next());
		System.out.println("----------------");
		System.out.println("Enter the movie Genre");
		m.setMovieGenre(sc.next());
		System.out.println("----------------");
		System.out.println("Enter the movie Verdit");
		m.setMovieVerdict(sc.next());
		System.out.println("----------------");
		System.out.println("Enter the movie Collection");
		m.setMovieCollection(sc.nextInt());

		emf = Persistence.createEntityManagerFactory("mysql-config");
		EntityManager em = emf.createEntityManager();
		EntityTransaction et = em.getTransaction();
		et.begin();
		List<Actor>actorsIdList=new ArrayList<Actor>();
		Query query = em.createQuery("FROM Actor");
		List<Actor> actorList = query.getResultList();
		System.out.println("the details of Actors are");
		for (Actor actor : actorList) {
			System.out.println(actor);
		}
		System.out.println("Enter the Ids With Seprated by commas(  ,  )");
		String id=sc.next();
		
		String[] actorIds=id.split(",");
		
		for(String s:actorIds) {
			int actorId=Integer.parseInt(s);
			Actor actor=em.find(Actor.class, actorId);
			
			
			if(actor!=null) {
				actorsIdList.add(actor);
			}
			else {
				System.err.println("Not found actor ids");
			}
		}
		
		// Adding actors to movie and persisting the movie
		m.setActors(actorsIdList);
		em.persist(m);
		System.out.println("Movie added successfully with selected actors!");
		
		et.commit();
		em.close();
		if (emf != null) {
			emf.close();
		}

	}
	public void findMovieByTitle() {
		emf = Persistence.createEntityManagerFactory("mysql-config");
		EntityManager em = emf.createEntityManager();
		EntityTransaction et = em.getTransaction();
		et.begin();
		System.out.println("Enter the Movie Title to Display");
		String movieTitle=sc.next();
		Query query=em.createQuery("SELECT m FROM Movie m WHERE m.movieTitle=:a");
		query.setParameter("a", movieTitle);
		List<Movie> movies=query.getResultList();
		for (Movie movie : movies) {
			System.out.println(movie);
		}
		
		et.commit();
		em.close();
		if (emf != null) {
			emf.close();
		}
	}
	public void findMovieByGenre() {
		emf = Persistence.createEntityManagerFactory("mysql-config");
		EntityManager em = emf.createEntityManager();
		EntityTransaction et = em.getTransaction();
		et.begin();
		System.out.println("Enter the Movie Genre");
		Query query=em.createQuery("Select m from Movie m where m.movieGenre=:a");
		query.setParameter("a", sc.next());
		List<Movie> movieList=query.getResultList();
		for(Movie movies:movieList) {
			System.out.println(movies);
		}
		
		
		et.commit();
		em.close();
		if (emf != null) {
			emf.close();
		}
	}
	
	public void findMovieByDirector() {
		emf = Persistence.createEntityManagerFactory("mysql-config");
		EntityManager em = emf.createEntityManager();
		EntityTransaction et = em.getTransaction();
		et.begin();
		
		CriteriaBuilder builder=em.getCriteriaBuilder();
		
		CriteriaQuery<Movie> cq=builder.createQuery(Movie.class);
		Root<Movie> root=cq.from(Movie.class);
		
		System.out.println("Enter the name of the Director");
		cq.where(builder.equal(root.get("movieDirector"), sc.next()));
		
		Query query=em.createQuery(cq);
		List<Movie> movie=query.getResultList();
		for (Movie movies : movie) {
			System.out.println(movies);
		}
	
		et.commit();
		em.close();
		if (emf != null) {
			emf.close();
		}
	}
	
	public void findMovieByActionName() {
		emf = Persistence.createEntityManagerFactory("mysql-config");
		EntityManager em = emf.createEntityManager();
		EntityTransaction et = em.getTransaction();
		et.begin();
		CriteriaBuilder builder=em.getCriteriaBuilder();
		
		CriteriaQuery<Actor> cq=builder.createQuery(Actor.class);
		Root<Actor> root=cq.from(Actor.class);
		
		System.out.println("Enter the Actor Name");
		cq.where(builder.equal(root.get("actorName"), sc.next()));
		
		Query query=em.createQuery(cq);
		List<Actor> actors=query.getResultList();
		for (Actor actor : actors) {
		System.out.println(actor.getMovies());			
			}
		
		et.commit();
		em.close();
		if (emf != null) {
			emf.close();
		}
	}
	public void updateMovieCollectionByVerdict() {
		emf = Persistence.createEntityManagerFactory("mysql-config");
		EntityManager em = emf.createEntityManager();
		EntityTransaction et = em.getTransaction();
		et.begin();
		System.out.println("Enter the Movie Verdict");
		Query query=em.createQuery("Select m from Movie m where m.movieVerdict=:a");
		query.setParameter("a", sc.next());
		
		System.out.println("Enter the Collection to update");
		int collection=sc.nextInt();
		
		List<Movie>  movie=query.getResultList();
		for(Movie Movies:movie) {
			Movies.setMovieCollection(Movies.getMovieCollection()+collection);
		}
		et.commit();
		em.close();
		if (emf != null) {
			emf.close();
		}
	}

}
/*
System.out.println("enter the Actor Ids separeted with commas");
String id = sc.nextLine();
String[] actorIds = id.split(",");
List<Actor> actorIdList = new ArrayList<Actor>();
for (String s : actorIds) {
	int actorid = Integer.parseInt(s);
	Actor actor = em.find(Actor.class, actorid);
	if (actor != null) {
		actorIdList.add(actor);

	} else {
		System.err.println("Actor with id not found");
	}
}
*/
